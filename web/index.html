<html>
<head>
	<title>LevelGraph Tests</title>
</head>
<body>
	asdf
</body>
<!-- <script src="js/levelgraph.min.js"></script> -->
<script src="js/pouchdb-5.2.0.min.js"></script>
<script src="js/geopouch-downloaded.js"></script>
<script>
	// var graphdb = levelgraph(level("vienna_roads_graph"));
    PouchDB.plugin(geopouch);
	var docdb = new PouchDB('http://gi88.geoinfo.tuwien.ac.at:5984/vienna_graph2');
    var localdocdb = new PouchDB('vienna_road_docs');
	var batchpos = 0;

    // the following code-block syncs the local pouchDB with the remote couchDB and activates live-sync
    
    
    PouchDB.replicate(docdb, localdocdb, {live: true,
                                          retry: true }).on('complete', function()    { console.log("sync complete") })
                                                        .on('error',    function(err) { console.log(err)  })
                                                        .on('active',   function()    { console.log("sync watchdog barking") })
                                                        .on('change',   function()    { console.log("change in db detected, syncing ...") });
    
    
    // lets make a query to see how the secondary indices perform
    /*
    console.log("Starting Test-Query ...");
    localdocdb.query('graph/source', {key: 333, reduce: false})
                                    .then( function (res) {
                                        console.log("Test-Query complete. Results are:");
                                        console.log(res);
                                  }).catch(function (err) {
                                      console.log("There was an error with the Test-Query:");
                                        console.log(err);
                                  });
    */
    
    //getEdgesFromNode(4);
    
    function getEdgesFromNode(nodeID){
        console.log("query for outgoing edges of node #"+nodeID+" ...");
        localdocdb.query('graph/edgesofnode', {key: nodeID, reduce: false, include_docs: true})
                                            .then( function (res) {
                                                console.log("result of query for node #"+nodeID+":");
                                                console.log(res);
                                            }).catch(function(err) {
                                                console.log("ERROR of query for node #"+nodeID+":");
                                                console.log(err);
                                            });
    };
    
    //docdb.spatial('graph/roads', [0, 0, 180, 90], {limit: 5}, function(resul){console.log(resul);} );
    
	// the following code-block loads all data from the couchdb to be stored in the local levelgraph database
	/*
	docdb.allDocs({ include_docs: true}
		).then(function (results){
			results = results.rows;
			console.log("start looping");
			var allTriples = [];
			for(var resultindex in results){
				var result = results[resultindex].doc;
				var triple = {subject: result.source, predicate: result.length, object: result.target};
				allTriples.push(triple);
				//console.log("pushed: ", triple);
			};
			console.log("start storing graph");
			graphdb.put(allTriples, function(err){
				if (err){
					console.log(err);
				} else {
					console.log("finished graph storage");
				};
			});
		});
	*/
</script>
</html>
